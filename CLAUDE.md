# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Backend (FastAPI)
- **Start development server**: `uvicorn app:app --reload --port 8004`
- **Run tests**: `pytest` (tests include test_app.py, test_modules.py, test_weighting.py, test_postgresql.py)
- **Run single test file**: `pytest test_app.py` or `pytest test_modules.py -v`
- **Check imports**: `python -c "import app; print('App imports successfully')"`
- **Docker build**: `docker build -t portfolio-analysis .`
- **Docker run**: `docker run -p 8004:8004 portfolio-analysis`
- **Docker compose**: `docker-compose up`

### Frontend (React + TypeScript)
- **Start development server**: `cd frontend && npm run dev`
- **Build for production**: `cd frontend && npm run build`
- **Run linter**: `cd frontend && npm run lint`
- **Preview production build**: `cd frontend && npm run preview`

### Database Management
- **Initialize database**: `python init_db.py`
- **Create tables**: `python create_tables.py`
- **Check database connection**: `python check_env.py`

## Architecture Overview

This is a **dual-architecture application** with both traditional server-side rendering and a modern React frontend:

### Backend Architecture (FastAPI)
- **FastAPI app**: Main application in `app.py` with HTML template rendering and REST API endpoints
- **Database**: PostgreSQL (production) with SQLite fallback, using SQLAlchemy ORM
- **Core modules**:
  - `portfolio_processor.py`: Core portfolio analysis logic
  - `portfolio_blender.py`: Multi-portfolio analysis and blending
  - `plotting.py`: Chart generation (matplotlib/seaborn)
  - `portfolio_service.py`: Database service layer
  - `models.py`: SQLAlchemy database models
  - `config.py`: Configuration constants
  - `database.py`: Database connection and session management

### Frontend Architecture (React)
- **React 18** with TypeScript and Vite build system
- **React Router** for client-side routing
- **Axios** for API communication
- **Component structure**:
  - `Navigation.tsx`: Main navigation component
  - `Home.tsx`, `Upload.tsx`, `Portfolios.tsx`, `Analysis.tsx`: Page components
  - `api.ts`: API service layer

### Dual Endpoints
The application serves both:
1. **Traditional HTML endpoints** (`/`, `/portfolios`) with Jinja2 templates
2. **REST API endpoints** (`/api/strategies`, `/api/portfolio/{id}`) for React frontend

### Key Features
- **Portfolio Analysis**: Calculates comprehensive risk metrics (Sharpe ratio, CAGR, max drawdown, etc.)
- **Monte Carlo Simulation**: 1000-scenario forecasting with percentile analysis
- **Multi-Portfolio Analysis**: Correlation analysis and blended portfolio creation
- **Database Persistence**: Stores portfolios, analysis results, and generated plots
- **File Upload**: CSV processing with automatic column detection
- **Weighting Options**: Equal weighting or custom weight allocation for portfolio blending

### Data Flow
1. CSV files uploaded via FastAPI endpoints
2. Data processed by `portfolio_processor.py` and stored in database
3. Analysis results and plots generated by `plotting.py`
4. Results served via both HTML templates and REST API
5. React frontend consumes REST API for modern SPA experience

### Environment Configuration
- **Database**: Uses `DATABASE_URL` environment variable for PostgreSQL, falls back to SQLite
- **File Storage**: Uploads stored in `uploads/` directory with `plots/` subdirectory
- **Default Parameters**: Risk-free rate 4.3%, starting capital $100k, 20-day SMA window

### Testing Strategy
- **Backend**: pytest with async support for FastAPI endpoints
- **Frontend**: ESLint for code quality
- **CI/CD**: GitHub Actions with security scanning (safety, bandit)
- **Docker**: Multi-stage builds with health checks