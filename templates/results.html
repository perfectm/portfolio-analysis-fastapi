<!DOCTYPE html>
<html>
<head>
    <title>Analysis Results</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .result-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .plots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .plot img {
            max-width: 100%;
            height: auto;
        }
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .download-link:hover {
            background-color: #45a049;
        }
        h2 {
            color: #333;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .error {
            color: red;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
        }
        .correlation-plot {
            max-width: 800px;
            margin: 0 auto;
        }
        .correlation-note {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-top: 15px;
        }
        .chart-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #4CAF50;
            margin-top: 10px;
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .chart-toggle:hover {
            color: #45a049;
        }
        .triangle {
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        .triangle.open {
            transform: rotate(90deg);
        }
        .charts-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .charts-container.open {
            max-height: 2000px;
        }
        
        /* Re-balancing Interface Styles */
        .rebalance-section {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .rebalance-section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .weights-container {
            margin: 15px 0;
        }
        .weight-input-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }
        .weight-input-group label {
            min-width: 200px;
            font-weight: bold;
        }
        .weight-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .weight-percentage {
            font-size: 14px;
            color: #666;
            min-width: 60px;
        }
        .weight-total {
            font-weight: bold;
            margin: 15px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .weight-total.valid {
            background-color: #d4edda;
            color: #155724;
        }
        .weight-total.invalid {
            background-color: #f8d7da;
            color: #721c24;
        }
        .rebalance-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .weighting-method {
            margin: 15px 0;
        }
        .weighting-method label {
            margin-right: 15px;
        }
    </style>
    <script>
        function toggleCharts(button) {
            const triangle = button.querySelector('.triangle');
            const text = button.querySelector('span:last-child');
            const container = button.nextElementSibling;
            
            if (container.classList.contains('open')) {
                container.classList.remove('open');
                triangle.classList.remove('open');
                text.textContent = 'Show Charts';
            } else {
                container.classList.add('open');
                triangle.classList.add('open');
                text.textContent = 'Hide Charts';
            }
        }
        
        function formatPortfolioName(filename) {
            return filename.replace('.csv', '')
                          .replace(/(\d)-(\d)/g, '$1:$2')
                          .replace(/-/g, ' ');
        }
        
        // Re-balancing Interface Functions
        function updateWeightingMethod() {
            const equalWeight = document.querySelector('input[name="rebalance_weighting_method"][value="equal"]').checked;
            const customWeights = document.getElementById('rebalanceCustomWeights');
            
            if (equalWeight) {
                customWeights.style.display = 'none';
                setEqualWeights();
            } else {
                customWeights.style.display = 'block';
                updateWeightTotal();
            }
        }
        
        function setEqualWeights() {
            const weightInputs = document.querySelectorAll('.rebalance-weight-input');
            const equalWeight = 1.0 / weightInputs.length;
            
            weightInputs.forEach(input => {
                input.value = equalWeight.toFixed(3);
            });
            updateWeightTotal();
        }
        
        function updateWeightTotal() {
            const weightInputs = document.querySelectorAll('.rebalance-weight-input');
            const percentageSpans = document.querySelectorAll('.rebalance-weight-percentage');
            let total = 0;
            
            weightInputs.forEach((input, index) => {
                const value = parseFloat(input.value) || 0;
                total += value;
                
                if (percentageSpans[index]) {
                    percentageSpans[index].textContent = '(' + (value * 100).toFixed(1) + '%)';
                }
            });
            
            const totalElement = document.getElementById('rebalanceWeightTotal');
            const percentage = (total * 100).toFixed(1);
            totalElement.textContent = `Total: ${total.toFixed(3)} (${percentage}%)`;
            
            totalElement.classList.remove('valid', 'invalid');
            if (Math.abs(total - 1.0) < 0.001) {
                totalElement.classList.add('valid');
            } else {
                totalElement.classList.add('invalid');
            }
        }
        
        function normalizeRebalanceWeights() {
            const weightInputs = document.querySelectorAll('.rebalance-weight-input');
            let total = 0;
            
            weightInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            if (total > 0) {
                weightInputs.forEach(input => {
                    const currentValue = parseFloat(input.value) || 0;
                    const normalizedValue = currentValue / total;
                    input.value = normalizedValue.toFixed(3);
                });
                updateWeightTotal();
            }
        }
        
        function submitRebalance() {
            const form = document.getElementById('rebalanceForm');
            const weightingMethod = document.querySelector('input[name="rebalance_weighting_method"]:checked').value;
            
            if (weightingMethod === 'custom') {
                const weightInputs = document.querySelectorAll('.rebalance-weight-input');
                let total = 0;
                weightInputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                
                if (Math.abs(total - 1.0) > 0.001) {
                    alert('Weights must sum to 1.0 (100%). Current sum: ' + total.toFixed(3));
                    return;
                }
            }
            
            form.submit();
        }
        
        function resetToCurrentWeights() {
            const currentWeights = document.querySelectorAll('.current-weight-value');
            const weightInputs = document.querySelectorAll('.rebalance-weight-input');
            
            currentWeights.forEach((span, index) => {
                if (weightInputs[index]) {
                    const weight = parseFloat(span.textContent);
                    weightInputs[index].value = weight.toFixed(3);
                }
            });
            updateWeightTotal();
        }
        
        // Initialize rebalancing interface when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const rebalanceForm = document.getElementById('rebalanceForm');
            if (rebalanceForm) {
                updateWeightingMethod();
                updateWeightTotal();
                
                const fileNote = document.createElement('div');
                fileNote.style.cssText = 'background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 14px;';
                fileNote.innerHTML = '<strong>üìÅ Note:</strong> To re-analyze with new weights, you\'ll need to upload the same CSV files again. The system will preserve your analysis parameters and apply the new weights.';
                rebalanceForm.insertBefore(fileNote, rebalanceForm.firstChild);
                
                const fileInputDiv = document.createElement('div');
                fileInputDiv.innerHTML = `
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">Re-upload CSV files:</label>
                        <input type="file" name="files" accept=".csv" multiple required style="margin-top: 5px; width: 100%;">
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Upload the same CSV files in the same order to maintain weight assignments</div>
                    </div>
                `;
                fileNote.insertAdjacentElement('afterend', fileInputDiv);
            }
        });
    </script>
</head>
<body>
    <h1>Portfolio Analysis Results</h1>
    
    {% if not results %}
    <div class="error">
        No results were generated. Please check if your CSV files contain the required columns (Date and P/L).
    </div>
    {% endif %}
    
    {% if blended_result %}
    <!-- 1. BLENDED PORTFOLIO RESULTS - TOP PRIORITY -->
    <div class="result-section" style="background-color: #f8f9fa; border: 2px solid #28a745;">
        <h2 style="color: #28a745;">üéØ {{ blended_result.filename }}</h2>
        
        {% if blended_result.metrics and 'Portfolio_Weights' in blended_result.metrics %}
        <div class="metric" style="background-color: #e7f3ff; border: 1px solid #90caf9; margin-bottom: 15px;">
            <strong>Portfolio Composition:</strong><br>
            <div style="margin-top: 5px;">
                <strong>Weighting Method:</strong> {{ blended_result.metrics['Weighting_Method'] }}<br>
                {% for portfolio, weight in blended_result.metrics['Portfolio_Weights'].items() %}
                    <div style="margin-top: 3px;">
                        <strong>{{ portfolio }}:</strong> {{ "{:.1f}%".format(weight * 100) }} ({{ "{:.3f}".format(weight) }})
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if blended_result.metrics %}
        <div class="metrics">
            {% set metric_order = [
                'Sharpe Ratio', 'MAR Ratio', 'CAGR', 'Annual Volatility', 
                'Total Return', 'Total P/L', 'Final Account Value', 'Peak Value',
                'Number of Trading Days', 'Time Period (Years)', 'Recovery Days', 'Has Recovered'
            ] %}
            {% set drawdown_metrics = [
                'Max Drawdown', 'Max Drawdown %', 'Drawdown Start Date', 'Max Drawdown Date',
                'Account Value at Drawdown Start', 'Account Value at Max Drawdown'
            ] %}
            
            {% for name in metric_order %}
                {% if name in blended_result.metrics %}
            <div class="metric">
                <strong>{{ name }}:</strong>
                <br>
                {% if name == 'Has Recovered' %}
                    {{ "Yes" if blended_result.metrics[name] else "No" }}
                {% elif name == 'Recovery Days' %}
                    {{ "%.0f"|format(blended_result.metrics[name]) if blended_result.metrics[name] > 0 else "Not Yet Recovered" }}
                {% elif name == 'Number of Trading Days' %}
                    {{ "{:,}".format(blended_result.metrics[name]|int) }}
                {% elif name in ['Peak Value', 'Total P/L', 'Final Account Value'] %}
                    {{ "${:,.2f}".format(blended_result.metrics[name]) }}
                {% elif name in ['CAGR', 'Total Return', 'Annual Volatility'] %}
                    {{ "{:.2f}%".format(blended_result.metrics[name]) }}
                {% elif name in ['Sharpe Ratio', 'MAR Ratio'] %}
                    {{ "{:.2f}".format(blended_result.metrics[name]) }}
                {% elif name == 'Time Period (Years)' %}
                    {{ "{:.1f}".format(blended_result.metrics[name]) }}
                {% else %}
                    {{ "%.4f"|format(blended_result.metrics[name]) }}
                {% endif %}
            </div>
                {% endif %}
            {% endfor %}
            
            <div style="grid-column: 1 / -1; height: 20px;"></div>
            
            {% for name in drawdown_metrics %}
                {% if name in blended_result.metrics %}
            <div class="metric">
                <strong>{{ name }}:</strong>
                <br>
                {% if name in ['Max Drawdown', 'Account Value at Drawdown Start', 'Account Value at Max Drawdown'] %}
                    {{ "${:,.2f}".format(blended_result.metrics[name]) }}
                {% elif name == 'Max Drawdown %' %}
                    {{ "{:.2f}%".format(blended_result.metrics[name]) }}
                {% elif name in ['Max Drawdown Date', 'Drawdown Start Date'] %}
                    {{ blended_result.metrics[name] }}
                {% else %}
                    {{ "%.4f"|format(blended_result.metrics[name]) }}
                {% endif %}
            </div>
                {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="error">No metrics were calculated for the blended portfolio.</div>
        {% endif %}
        
        {% if blended_result.plots %}
        <button class="chart-toggle" onclick="toggleCharts(this)">
            <span class="triangle">‚ñ∂</span>
            <span>Show Charts</span>
        </button>
        <div class="charts-container">
            <div class="plots">
                {% for plot in blended_result.plots %}
                <div class="plot">
                    <img src="{{ plot.url }}" alt="Blended Portfolio Analysis Plot">
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="error">No plots were generated for the blended portfolio.</div>
        {% endif %}
    </div>
    
    <!-- 2. RE-BALANCING INTERFACE - SECOND PRIORITY -->
    <div class="rebalance-section">
        <h3>üîÑ Re-balance Portfolio Weights</h3>
        <p>Adjust the portfolio weights and re-run the analysis to optimize your blended portfolio performance.</p>
        
        <form id="rebalanceForm" action="/upload" method="post" enctype="multipart/form-data">
            <input type="hidden" name="rf_rate" value="{{ analysis_params.rf_rate if analysis_params else '0.043' }}">
            <input type="hidden" name="daily_rf_rate" value="{{ analysis_params.daily_rf_rate if analysis_params else '0.0002' }}">
            <input type="hidden" name="sma_window" value="{{ analysis_params.sma_window if analysis_params else '20' }}">
            <input type="hidden" name="use_trading_filter" value="{{ analysis_params.use_trading_filter if analysis_params else 'true' }}">
            <input type="hidden" name="starting_capital" value="{{ analysis_params.starting_capital if analysis_params else '100000' }}">
            
            <div class="weighting-method">
                <label>
                    <input type="radio" name="rebalance_weighting_method" value="equal" onchange="updateWeightingMethod()"> Equal Weighting
                </label>
                <label>
                    <input type="radio" name="rebalance_weighting_method" value="custom" checked onchange="updateWeightingMethod()"> Custom Weighting
                </label>
            </div>
            
            <div class="weights-container">
                <h4>Current vs New Weights:</h4>
                {% if blended_result.metrics and 'Portfolio_Weights' in blended_result.metrics %}
                    {% for portfolio, weight in blended_result.metrics['Portfolio_Weights'].items() %}
                    <div class="weight-input-group">
                        <label>{{ portfolio }}:</label>
                        <span class="weight-percentage">Current: <span class="current-weight-value">{{ "{:.3f}".format(weight) }}</span> ({{ "{:.1f}%".format(weight * 100) }})</span>
                        <span style="margin: 0 10px;">‚Üí</span>
                        <input type="number" 
                               name="weights" 
                               class="rebalance-weight-input weight-input" 
                               value="{{ "{:.3f}".format(weight) }}" 
                               step="0.001" 
                               min="0" 
                               max="1" 
                               oninput="updateWeightTotal()">
                        <span class="rebalance-weight-percentage weight-percentage">({{ "{:.1f}%".format(weight * 100) }})</span>
                    </div>
                    {% endfor %}
                {% else %}
                    {% set equal_weight = 1.0 / results|length %}
                    {% for result in results %}
                    <div class="weight-input-group">
                        <label>{{ result.filename.replace('.csv', '') }}:</label>
                        <span class="weight-percentage">Current: <span class="current-weight-value">{{ "{:.3f}".format(equal_weight) }}</span> ({{ "{:.1f}%".format(equal_weight * 100) }})</span>
                        <span style="margin: 0 10px;">‚Üí</span>
                        <input type="number" 
                               name="weights" 
                               class="rebalance-weight-input weight-input" 
                               value="{{ "{:.3f}".format(equal_weight) }}" 
                               step="0.001" 
                               min="0" 
                               max="1" 
                               oninput="updateWeightTotal()">
                        <span class="rebalance-weight-percentage weight-percentage">({{ "{:.1f}%".format(equal_weight * 100) }})</span>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div id="rebalanceCustomWeights">
                <div class="weight-total" id="rebalanceWeightTotal">Total: 1.000 (100.0%)</div>
                <div class="rebalance-buttons">
                    <button type="button" class="btn btn-secondary" onclick="normalizeRebalanceWeights()">Normalize to 100%</button>
                    <button type="button" class="btn btn-secondary" onclick="setEqualWeights()">Set Equal Weights</button>
                    <button type="button" class="btn btn-secondary" onclick="resetToCurrentWeights()">Reset to Current</button>
                    <button type="button" class="btn btn-primary" onclick="submitRebalance()">üîÑ Re-analyze with New Weights</button>
                </div>
            </div>
        </form>
        
        <div style="margin-top: 15px; padding: 10px; background-color: #e7f3ff; border-radius: 4px; font-size: 14px;">
            <strong>üí° Tips:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Increase weights for portfolios with better Sharpe ratios</li>
                <li>Consider reducing weights for portfolios with high drawdowns</li>
                <li>Weights must sum to exactly 1.0 (100%)</li>
                <li>Use "Normalize" to automatically adjust weights to sum to 100%</li>
            </ul>
        </div>
    </div>
    {% endif %}
    
    <!-- 3. INDIVIDUAL PORTFOLIO RESULTS - THIRD PRIORITY -->
    {% if results %}
    <div style="margin-top: 30px;">
        <h2 style="color: #6c757d;">üìä Individual Portfolio Analysis</h2>
        <p style="color: #6c757d; margin-bottom: 20px;">Detailed analysis of each portfolio before blending:</p>
    </div>
    
    {% for result in results %}
    {% set formatted_name = result.filename.replace('.csv', '') %}
    {% set formatted_name = formatted_name.replace('0-0', '0:0').replace('0-1', '0:1').replace('0-2', '0:2').replace('0-3', '0:3').replace('0-4', '0:4').replace('0-5', '0:5').replace('0-6', '0:6').replace('0-7', '0:7').replace('0-8', '0:8').replace('0-9', '0:9') %}
    {% set formatted_name = formatted_name.replace('1-0', '1:0').replace('1-1', '1:1').replace('1-2', '1:2').replace('1-3', '1:3').replace('1-4', '1:4').replace('1-5', '1:5').replace('1-6', '1:6').replace('1-7', '1:7').replace('1-8', '1:8').replace('1-9', '1:9') %}
    {% set formatted_name = formatted_name.replace('2-0', '2:0').replace('2-1', '2:1').replace('2-2', '2:2').replace('2-3', '2:3').replace('2-4', '2:4').replace('2-5', '2:5').replace('2-6', '2:6').replace('2-7', '2:7').replace('2-8', '2:8').replace('2-9', '2:9') %}
    {% set formatted_name = formatted_name.replace('3-0', '3:0').replace('3-1', '3:1').replace('3-2', '3:2').replace('3-3', '3:3').replace('3-4', '3:4').replace('3-5', '3:5').replace('3-6', '3:6').replace('3-7', '3:7').replace('3-8', '3:8').replace('3-9', '3:9') %}
    {% set formatted_name = formatted_name.replace('4-0', '4:0').replace('4-1', '4:1').replace('4-2', '4:2').replace('4-3', '4:3').replace('4-4', '4:4').replace('4-5', '4:5').replace('4-6', '4:6').replace('4-7', '4:7').replace('4-8', '4:8').replace('4-9', '4:9') %}
    {% set formatted_name = formatted_name.replace('5-0', '5:0').replace('5-1', '5:1').replace('5-2', '5:2').replace('5-3', '5:3').replace('5-4', '5:4').replace('5-5', '5:5').replace('5-6', '5:6').replace('5-7', '5:7').replace('5-8', '5:8').replace('5-9', '5:9') %}
    {% set formatted_name = formatted_name.replace('6-0', '6:0').replace('6-1', '6:1').replace('6-2', '6:2').replace('6-3', '6:3').replace('6-4', '6:4').replace('6-5', '6:5').replace('6-6', '6:6').replace('6-7', '6:7').replace('6-8', '6:8').replace('6-9', '6:9') %}
    {% set formatted_name = formatted_name.replace('7-0', '7:0').replace('7-1', '7:1').replace('7-2', '7:2').replace('7-3', '7:3').replace('7-4', '7:4').replace('7-5', '7:5').replace('7-6', '7:6').replace('7-7', '7:7').replace('7-8', '7:8').replace('7-9', '7:9') %}
    {% set formatted_name = formatted_name.replace('8-0', '8:0').replace('8-1', '8:1').replace('8-2', '8:2').replace('8-3', '8:3').replace('8-4', '8:4').replace('8-5', '8:5').replace('8-6', '8:6').replace('8-7', '8:7').replace('8-8', '8:8').replace('8-9', '8:9') %}
    {% set formatted_name = formatted_name.replace('9-0', '9:0').replace('9-1', '9:1').replace('9-2', '9:2').replace('9-3', '9:3').replace('9-4', '9:4').replace('9-5', '9:5').replace('9-6', '9:6').replace('9-7', '9:7').replace('9-8', '9:8').replace('9-9', '9:9') %}
    {% set formatted_name = formatted_name.replace('-', ' ') %}
    <div class="result-section">
        <h2>{{ formatted_name }}</h2>
        
        {% if result.metrics %}
        <div class="metrics">
            {% set metric_order = [
                'Sharpe Ratio', 'MAR Ratio', 'CAGR', 'Annual Volatility', 
                'Total Return', 'Total P/L', 'Final Account Value', 'Peak Value',
                'Number of Trading Days', 'Time Period (Years)', 'Recovery Days', 'Has Recovered'
            ] %}
            {% set drawdown_metrics = [
                'Max Drawdown', 'Max Drawdown %', 'Drawdown Start Date', 'Max Drawdown Date',
                'Account Value at Drawdown Start', 'Account Value at Max Drawdown'
            ] %}
            
            {% for name in metric_order %}
                {% if name in result.metrics %}
            <div class="metric">
                <strong>{{ name }}:</strong>
                <br>
                {% if name == 'Has Recovered' %}
                    {{ "Yes" if result.metrics[name] else "No" }}
                {% elif name == 'Recovery Days' %}
                    {{ "%.0f"|format(result.metrics[name]) if result.metrics[name] > 0 else "Not Yet Recovered" }}
                {% elif name == 'Number of Trading Days' %}
                    {{ "{:,}".format(result.metrics[name]|int) }}
                {% elif name in ['Peak Value', 'Total P/L', 'Final Account Value'] %}
                    {{ "${:,.2f}".format(result.metrics[name]) }}
                {% elif name in ['CAGR', 'Total Return', 'Annual Volatility'] %}
                    {{ "{:.2f}%".format(result.metrics[name]) }}
                {% elif name in ['Sharpe Ratio', 'MAR Ratio'] %}
                    {{ "{:.2f}".format(result.metrics[name]) }}
                {% elif name == 'Time Period (Years)' %}
                    {{ "{:.1f}".format(result.metrics[name]) }}
                {% else %}
                    {{ "%.4f"|format(result.metrics[name]) }}
                {% endif %}
            </div>
                {% endif %}
            {% endfor %}
            
            <div style="grid-column: 1 / -1; height: 20px;"></div>
            
            {% for name in drawdown_metrics %}
                {% if name in result.metrics %}
            <div class="metric">
                <strong>{{ name }}:</strong>
                <br>
                {% if name in ['Max Drawdown', 'Account Value at Drawdown Start', 'Account Value at Max Drawdown'] %}
                    {{ "${:,.2f}".format(result.metrics[name]) }}
                {% elif name == 'Max Drawdown %' %}
                    {{ "{:.2f}%".format(result.metrics[name]) }}
                {% elif name in ['Max Drawdown Date', 'Drawdown Start Date'] %}
                    {{ result.metrics[name] }}
                {% else %}
                    {{ "%.4f"|format(result.metrics[name]) }}
                {% endif %}
            </div>
                {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="error">No metrics were calculated for this file.</div>
        {% endif %}
        
        {% if result.plots %}
        <button class="chart-toggle" onclick="toggleCharts(this)">
            <span class="triangle">‚ñ∂</span>
            <span>Show Charts</span>
        </button>
        <div class="charts-container">
            <div class="plots">
                {% for plot in result.plots %}
                <div class="plot">
                    <img src="{{ plot.url }}" alt="Analysis Plot">
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="error">No plots were generated for this file.</div>
        {% endif %}
        
        {% if result.processed_file %}
        <a href="{{ result.processed_file }}" class="download-link">Download Processed Data</a>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}
    
    <!-- 4. CORRELATION ANALYSIS -->
    {% if results|length > 1 %}
        {% if heatmap_url %}
        <div class="result-section">
            <h2>üìà Portfolio Correlation Analysis</h2>
            <div class="plot correlation-plot">
                <img src="{{ heatmap_url }}" alt="Portfolio Correlation Heatmap">
            </div>
            <p class="correlation-note">
                Correlation values range from -1 (perfect negative correlation) to 1 (perfect positive correlation).
                Values close to 0 indicate little to no correlation between portfolios.
            </p>
        </div>
        {% else %}
        <div class="result-section">
            <div class="error">
                Unable to generate correlation analysis. Please ensure all portfolios contain valid daily return data.
            </div>
        </div>
        {% endif %}
    {% endif %}
    
    <!-- 5. MONTE CARLO SIMULATION -->
    {% if monte_carlo_url %}
    <div class="result-section">
        <h2>üé≤ Monte Carlo Simulation - Blended Portfolio</h2>
        <div class="plot correlation-plot">
            <img src="{{ monte_carlo_url }}" alt="Monte Carlo Simulation">
        </div>
        <p class="correlation-note">
            Monte Carlo simulation shows potential future portfolio paths based on historical return patterns.
            The simulation projects 1,000 possible scenarios over the next trading year (252 days).
        </p>
    </div>
    {% endif %}
    
    <p>
        <a href="/" class="download-link">Analyze Another Portfolio</a>
    </p>
    
    <!-- Debug Information -->
    <div class="debug-info">
        <h3>Debug Information:</h3>
        <pre>Number of results: {{ results|length }}</pre>
        {% for result in results %}
        <pre>
File: {{ result.filename }}
Metrics: {{ result.metrics|default('None') }}
Plots: {{ result.plots|default('None') }}
Processed File: {{ result.processed_file|default('None') }}
        </pre>
        {% endfor %}
    </div>
</body>
</html>